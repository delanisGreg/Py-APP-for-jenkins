pipeline {
	agent {
		label 'master'
		}
	stages {
		stage("Create docker image") {
			steps ('Build') {
				echo "========= start building image ========="
//				app = docker.build("./docker/toolbox")
				dir ('docker/toolbox') {
					sh 'docker build -t gregdelanis/app4:2.0 .'
					}
				}
			}
	
		stage('Push image') {
			withCredentials([string(credentialsId: 'dockerHubPasswd', variable: 'dockerHubPasswd')]) {
				sh "docker login -u gregdelanis -p ${dockerHubPasswd}"
			}
			
			sh 'docker push gregdelanis/app4:2.0'
		}
		
		stage('Run container'){
			def dockerRun = 'docker run -p 8080:8080 -d -- app4 gregdelanis/app4:2.0'
			sshagent(['DockerServer']) {
				sh "ssh -o StrictHostKeyChecking=no ec2-user@172.31.22.171 ${dockerRun}"
			}
		}
	}
}
